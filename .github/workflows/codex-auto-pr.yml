# Codexã®è¨­å®š: issueå®Œäº†æ™‚ã«è‡ªå‹•ã§PRã‚’ç”Ÿæˆã™ã‚‹
name: "Grim Issue Auto PR"

description: >
  GitHubã®å„issueãŒå®Œäº†ã—ãŸã‚‰ã€è‡ªå‹•çš„ã«ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã€
  ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¦mainã«ãƒãƒ¼ã‚¸æº–å‚™ã‚’è¡Œã†ã€‚

# å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
on:
  issue_comment:
    types: [created]

jobs:
  create_pr:
    if: contains(github.event.comment.body, '/done') || contains(github.event.comment.body, 'å®Œäº†')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Get issue info
        id: issue
        run: |
          echo "title=$(jq -r '.issue.title' $GITHUB_EVENT_PATH)" >> $GITHUB_OUTPUT
          echo "number=$(jq -r '.issue.number' $GITHUB_EVENT_PATH)" >> $GITHUB_OUTPUT
          echo "body=$(jq -r '.issue.body' $GITHUB_EVENT_PATH)" >> $GITHUB_OUTPUT

      - name: Create branch
        run: |
          BRANCH_NAME=feature/issue-${{ steps.issue.outputs.number }}
          git checkout -b $BRANCH_NAME

      - name: Commit changes
        run: |
          git config user.name "Codex Bot"
          git config user.email "codex-bot@example.com"
          git add .
          git commit -m "feat: å®Œäº†ã—ãŸIssue #${{ steps.issue.outputs.number }} - ${{ steps.issue.outputs.title }}" || echo "No changes to commit"

      - name: Push branch
        run: |
          git push origin HEAD

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ğŸ§© Issue #${{ steps.issue.outputs.number }} - ${{ steps.issue.outputs.title }}"
          body: |
            ### Issueå†…å®¹
            ${{ steps.issue.outputs.body }}

            ### è‡ªå‹•ç”Ÿæˆãƒ¡ãƒ¢
            - ã“ã®PRã¯Codexã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
            - å®Œäº†ã‚³ãƒ¡ãƒ³ãƒˆ: `${{ github.event.comment.body }}`
          branch: feature/issue-${{ steps.issue.outputs.number }}
          base: main
