**ファイルパス**: `docs/tests/test_3_post-timeline-and-detail-api.md`

# テストケース: 投稿タイムライン閲覧 API

対象 Issue: #3  
関連ドキュメント:

- [要件定義書](../01_requirements.md)
- [DB スキーマ定義](../03_database.md)
- [API 設計](../04_api.md)

---

## 概要

- 目的: タイムライン/投稿詳細 API が最新順リスト・詳細表示・ページネーションを正しく提供することを検証する。
- スコープ: `GET /api/v1/posts`（パラメータ: `page` `tab` 予定）と `GET /api/v1/posts/:id` のレスポンス構造・エラーハンドリング。
- 対象: `PostsController`（仮称）とシリアライザ、Post モデルの関連 eager load、ページネータ設定。

## 前提条件

- 環境: Ruby 3.1.6 / Rails 7.2。
- 初期データ: 投稿・ユーザー・書籍・タグ・いいね数を含むフィクスチャを用意（最新順検証のため日付差を付ける）。
- 認証: 本 Issue では不要（公開 API として想定）。

## AC トレーサビリティ

| AC 番号 | 内容（要約）                                                                 | 検証ケース ID                |
| ------- | ---------------------------------------------------------------------------- | ---------------------------- |
| AC-1    | `/posts` が最新順一覧を返し、ユーザー・書籍・タグ・likes_count を含む       | TEST-03-01, TEST-03-02       |
| AC-2    | `page` クエリでページネーションでき、無効値は 1 ページ目にフォールバック   | TEST-03-03                   |
| AC-3    | `/posts/:id` が詳細情報を返し、未存在 ID では `NOT_FOUND`                  | TEST-03-04, TEST-03-05       |
| AC-4    | タイムライン関連のリクエストテスト追加                                     | TEST-03-06                   |

## テスト観点一覧

- ポジティブ: 最新順ソート、詳細取得。
- ネガティブ: 存在しない投稿 ID、ページ番号不正。
- 境界値: ページサイズ境界（1件/ページ末尾）、関連データがない投稿（タグ無し）。
- パフォーマンス: N+1 無し（includes/serializer の検証）。

## テストケース（詳細）

| ID         | 観点               | 目的                                                                | 前提                                           | 手順                                                                                                                                   | 期待結果                                                                                              | AC   |
| ---------- | ------------------ | ------------------------------------------------------------------- | ---------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- | ---- |
| TEST-03-01 | 最新順一覧         | `/posts` が最新投稿から返却されるか確認                             | 3 件以上の投稿を異なる `created_at` で用意     | 1) `GET /api/v1/posts` を実行 2) レスポンスの並び順（最初が最新）を確認                                                               | 200 / 配列要素が最新順、各要素に `user` `book` `tags` `likes_count` フィールドあり                    | AC-1 |
| TEST-03-02 | 関連データ含有     | タグ・書籍がない投稿でも正しい JSON を返すか確認                    | タグ無し投稿・書籍 NIL の投稿を用意            | 1) `GET /api/v1/posts` 実行 2) 該当投稿の JSON フィールドが null/空配列で返ることを確認                                               | `tags` が空配列、`book` が null または必要最小フィールド、欠損フィールドがない                         | AC-1 |
| TEST-03-03 | ページネーション   | `page` クエリの有効・無効パターンを確認                             | 15 件程度の投稿を用意、デフォルト 10 件想定    | 1) `GET /api/v1/posts?page=2` 2) 第二ページの件数を確認 3) `page=abc` で再度実行                                                       | 正しい件数（例: 5 件）、無効値時は 1 ページ目が返る                                                   | AC-2 |
| TEST-03-04 | 詳細取得           | `/posts/:id` が全文・タグ・likes_count を返すか確認                 | 対象投稿 ID を把握                              | 1) `GET /api/v1/posts/:id` を実行 2) レスポンス構造を確認                                                                              | 200 / `data` に本文・ユーザー・書籍・likes_count・created_at 等が含まれる                              | AC-3 |
| TEST-03-05 | 詳細 404           | 存在しない ID へのアクセスで `NOT_FOUND` を返すか確認              | -                                              | 1) `GET /api/v1/posts/999999` を実行                                                                                                   | 404 / `status=error`、`error.code=NOT_FOUND`                                                           | AC-3 |
| TEST-03-06 | 自動テスト         | 追加したリクエストテストが成功することを確認                        | テスト環境構築済み                              | 1) `bin/rails test TEST=test/requests/api/v1/posts_test.rb` を実行                                                                     | 全テスト Pass                                                                                           | AC-4 |

## データセット（例）

- `posts.yml` に `created_at` の異なる複数投稿。
- タグ無し投稿、書籍 ID nil の投稿、likes_count の異なる投稿。
- ページング確認用に 15 件以上の投稿フィクスチャまたは FactoryBot 生成。

## 実行コマンド例

```bash
bin/rails test TEST=test/requests/api/v1/posts_test.rb
bin/rails test test/models/post_test.rb

# 手動確認
curl -s http://localhost:3000/api/v1/posts | jq '.data[0]'
```

## 成果物

- テスト結果を「検証結果」に追記し、必要に応じてレスポンス例を `docs/tests/assets/` へ保存。

## 検証結果（記録用）

| 実施日     | 担当      | 結果 | メモ |
| ---------- | --------- | ---- | ---- |
| 2025/10/26 | a.kawanobe | ✅   | `bundle exec rails test test/requests/api/v1/posts_test.rb` を実行し一覧/詳細/ページネーションの検証を完了 |

## 要確認事項（未確定・オープン）

- ページサイズ (`per_page`) の仕様（固定 10 件か、パラメータ許可か）。
- フォロー中タブ(`tab=following`) の実装時期・テスト方法（Issue #12 で対応予定）。

---
