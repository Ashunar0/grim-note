**ファイルパス**: `docs/tests/test_9_profile-read-and-update-api.md`

# テストケース: プロフィール閲覧・編集 API

対象 Issue: #9  
関連ドキュメント:

- [要件定義書](../01_requirements.md)
- [DB スキーマ定義](../03_database.md)
- [API 設計](../04_api.md)

---

## 概要

- 目的: プロフィール閲覧・編集 API がユーザー情報、統計、フォロー状態を適切に返し、本人以外の更新を拒否することを検証する。
- スコープ: `GET /api/v1/users/:id`、`PATCH /api/v1/profile`、レスポンスシリアライズ、権限制御。
- 対象: UsersController（API）、Follow/Like 統計計算、プロフィール更新バリデーション。

## 前提条件

- 環境: Ruby 3.1.6 / Rails 7.2。
- 認証: Issue #2 のセッション認証が利用可能。
- データ: 投稿・フォロー関係・プロフィール情報を含むフィクスチャを用意。

## AC トレーサビリティ

| AC 番号 | 内容（要約）                                                                 | 検証ケース ID                 |
| ------- | ---------------------------------------------------------------------------- | ----------------------------- |
| AC-1    | `/users/:id` がプロフィール・投稿一覧・フォロー統計を返す                     | TEST-09-01, TEST-09-02        |
| AC-2    | レスポンスに `is_following` `is_self` を含み、未ログイン時 false             | TEST-09-03                    |
| AC-3    | `PATCH /api/v1/profile` が本人のみ更新を許可し、他人だと `FORBIDDEN`         | TEST-09-04, TEST-09-05        |
| AC-4    | リクエストテスト追加                                                         | TEST-09-06                    |

## テスト観点一覧

- ポジティブ: プロフィール取得、本人更新。
- ネガティブ: 未ログインアクセス、他人プロフィール編集。
- データ整合: 投稿一覧ソート、フォローカウント・投稿数。
- 境界値: 自己紹介文字数上限、アイコン URL バリデーション。

## テストケース（詳細）

| ID         | 観点               | 目的                                                                           | 前提                               | 手順                                                                                                                                         | 期待結果                                                                                             | AC   |
| ---------- | ------------------ | ------------------------------------------------------------------------------ | ---------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ | ---- |
| TEST-09-01 | プロフィール取得   | `/users/:id` が基本情報と投稿一覧、統計値を返すか確認                           | 投稿・フォロー済みユーザーを用意   | 1) `GET /api/v1/users/:id` 実行 2) レスポンス内の `posts`・`follower_count`・`following_count`・`post_count` を確認                          | 200 / 期待値と一致                                                                                    | AC-1 |
| TEST-09-02 | 投稿一覧整合       | 投稿が最新順で返るか／必要フィールドを含むか確認                                | 異なる作成日時の投稿を用意         | 1) レスポンス `posts` の順序とフィールド（book/title/likes_count 等）を検証                                                                   | 最新投稿→古い投稿の順で並ぶ                                                                           | AC-1 |
| TEST-09-03 | フォロー状態/認証 | `is_following` と `is_self` がログイン状況に応じて正しいか確認、未ログインは 401 | `alice` フォロー/非フォローユーザー | 1) ログイン済みで他人プロフィールを取得→`is_following` の真偽を確認 2) 未ログインで同エンドポイント→401 とエラーコードを確認               | ログイン時: 自分= true/false、未ログイン: 401/`UNAUTHORIZED`                                         | AC-2 |
| TEST-09-04 | 本人更新成功       | `PATCH /api/v1/profile` が本人のみ成功するか確認                                | ログイン済みユーザー               | 1) プロフィール更新リクエスト送信 2) レスポンス・DB の値を確認                                                                              | 200 / `status=success`、DB の name/bio/icon_url が更新                                                | AC-3 |
| TEST-09-05 | 他人更新拒否       | 他ユーザーで `PATCH /api/v1/profile` を実行すると `FORBIDDEN` になるか確認      | 別ユーザーでログイン               | 1) 別ユーザーから対象ユーザーのプロフィールを更新しようとする                                                                               | 403 / `error.code=FORBIDDEN`                                                                          | AC-3 |
| TEST-09-06 | リクエストテスト   | 追加したリクエストテストが成功することを確認                                   | テスト環境構築済み                  | 1) `bin/rails test TEST=test/requests/api/v1/users_profile_test.rb` を実行                                                                   | 全テスト Pass                                                                                        | AC-4 |
| TEST-09-07 | URL バリデーション | `icon_url` が http/https 以外の場合に 422 を返すか確認                           | ログイン済みユーザー               | 1) `ftp://` など不正スキームで更新を送信                                                                                                    | 422 / `error.code=VALIDATION_ERROR`                                                                   | AC-3 |

## データセット（例）

- `users.yml`: `alice`（本人）, `bob`（他人）。
- `posts.yml`: `alice` の複数投稿。
- `follows.yml`: `alice`←`bob` フォロー関係。

## 実行コマンド例

```bash
bin/rails test TEST=test/requests/api/v1/users_profile_test.rb
bin/rails test test/models/user_test.rb
```

## 成果物

- テスト結果を「検証結果」に記録。必要に応じてレスポンスサンプルを保存。

## 検証結果（記録用）

| 実施日     | 担当 | 結果 | メモ |
| ---------- | ---- | ---- | ---- |
| 2025/10/28 | codex | ✅ | `bundle _2.3.27_ exec rails test` |

## 要確認事項（未確定・オープン）

- 投稿一覧のページサイズ（一覧 API と共通か）。
- フォローカウントのキャッシュ戦略（将来的なパフォーマンス対策）。

---
