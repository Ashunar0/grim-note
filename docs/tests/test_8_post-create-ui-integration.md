**ファイルパス**: `docs/tests/test_8_post-create-ui-integration.md`

# テストケース: 投稿作成 UI の API 連携

対象 Issue: #8  
関連ドキュメント:

- [要件定義書](../01_requirements.md)
- [API 設計](../04_api.md)
- [サイトマップ](../05_sitemap.md)

---

## 概要

- 目的: 投稿作成ページが書籍検索 API と投稿作成 API を利用し、バリデーション・エラー表示・リダイレクトまで正しく動作することを検証する。
- スコープ: `/books/search` の検索 UI、検索結果から `/posts/new` への選択連携、投稿フォーム送信、成功/失敗ハンドリング。
- 対象: 書籍検索ページの状態管理、フォームコンポーネント、Next.js ルーティング。

## 前提条件

- 環境: Node 20 / Next.js 13。
- API: Issue #6, #7 のバックエンドが稼働。
- 認証: Issue #4 の認証状態を利用（投稿はログイン必須）。

## AC トレーサビリティ

| AC 番号 | 内容（要約）                                                                               | 検証ケース ID                    |
| ------- | ------------------------------------------------------------------------------------------ | -------------------------------- |
| AC-1    | `/books/search` が API 結果を表示し、ローディング・エラー・0 件表示を切り替える            | TEST-08-01, TEST-08-02, TEST-08-03 |
| AC-2    | 検索結果から選択した書籍情報が `/posts/new` のフォームに反映される                        | TEST-08-04                       |
| AC-3    | 投稿フォーム送信時に API を呼び成功時にタイムラインへリダイレクト                         | TEST-08-05                       |
| AC-4    | バリデーションエラー表示と送信ボタン多重押下抑止                                           | TEST-08-06                       |

## テスト観点一覧

- ポジティブ: 検索→選択→投稿成功フロー。
- ネガティブ: API エラー、投稿 API バリデーションエラー。
- UX: ローディング表示、エラーステート、送信ボタン disable。
- 状態共有: 選択書籍の情報がフォームに埋め込まれる。

## テストケース（詳細）

| ID         | 観点               | 目的                                                                       | 前提                                     | 手順                                                                                                                                                     | 期待結果                                                                                          | AC   |
| ---------- | ------------------ | -------------------------------------------------------------------------- | ---------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------- | ---- |
| TEST-08-01 | 検索成功           | `/books/search` が検索結果を一覧表示するか確認                              | MSW で成功レスポンスをモック             | 1) 検索欄にキーワード入力→検索 2) 結果カードが描画されるか確認                                                                                           | 書籍タイトル・著者・出版年が表示                                                                | AC-1 |
| TEST-08-02 | 検索ローディング   | API 応答待ちのローディング表示を確認                                        | 200ms 遅延をモック                       | 1) 検索送信直後の表示を確認                                                                                                                               | ローディングスピナー/文言が表示                                                                   | AC-1 |
| TEST-08-03 | 検索エラー/0件     | API エラー時のメッセージ・0 件時の空表示を確認                              | 500 応答、および空配列をモック           | 1) エラー応答で再現→エラーバナー確認 2) 空配列で再現→「見つかりません」表示                                                                             | 適切なエラーメッセージと空状態表示                                                               | AC-1 |
| TEST-08-04 | 書籍選択連携       | 検索結果から選択した書籍情報が `/posts/new` フォームに反映されるか確認      | 選択ボタンが `/posts/new?book=...` を利用 | 1) 検索結果から「投稿する」をクリック 2) 投稿フォームに書籍タイトル/著者が初期表示されているか確認                                                       | ルーター遷移後のフォームに選択書籍情報が反映                                                    | AC-2 |
| TEST-08-05 | 投稿成功           | フォーム送信で API 成功→タイムラインへ戻るか確認                           | バックエンド API を成功モック            | 1) 必須項目入力 2) 送信→レスポンス成功 3) `/timeline` に遷移、成功トースト等を確認                                                                       | 200/201 応答後にタイムラインへリダイレクト                                                       | AC-3 |
| TEST-08-06 | 投稿エラー制御     | バリデーションエラー表示と送信ボタンの多重送信抑止を確認                    | API が 422 応答をモック                  | 1) 不完全入力で送信 2) エラーメッセージ表示とボタンが再度有効化されるまでの動作を確認                                                                   | 422 応答でフォーム内にエラー表示、二重送信が防止される                                           | AC-4 |

## データセット（例）

- 書籍検索モックレスポンス: タイトル、著者、ISBN13、published_year。
- 投稿 API 応答: 成功 JSON / `VALIDATION_ERROR` JSON をモック。
- テストユーザー Cookie: 認証済み状態を Playwright/RTL でモック。

## 実行コマンド例

```bash
npm run test        # React Testing Library
npm run test:e2e    # Playwright
npm run lint
```

## 成果物

- テスト結果を「検証結果」に記録、必要に応じてモックレスポンスを共有。

## 検証結果（記録用）

| 実施日     | 担当 | 結果 | メモ |
| ---------- | ---- | ---- | ---- |
| YYYY/MM/DD |      | ✅/❌ |      |

## 要確認事項（未確定・オープン）

- 書籍選択の状態保持方法（クエリ vs. Zustand など）によるテスト戦略差。
- 投稿成功後のユーザーフィードバック（トースト表示など）の仕様。

---
