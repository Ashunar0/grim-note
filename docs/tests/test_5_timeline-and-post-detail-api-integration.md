**ファイルパス**: `docs/tests/test_5_timeline-and-post-detail-api-integration.md`

# テストケース: タイムラインと投稿詳細の API 連携

対象 Issue: #5  
関連ドキュメント:

- [要件定義書](../01_requirements.md)
- [API 設計](../04_api.md)
- [サイトマップ](../05_sitemap.md)

---

## 概要

- 目的: Next.js タイムライン・投稿詳細ページがバックエンド API と連携し、ローディング・エラー・空表示まで正しく処理するかを検証。
- スコープ: `/timeline` ページの一覧、タブ切替時のクエリ送信、`/posts/:id` 詳細取得、404 表示、共通 PostCard 更新。
- 対象: API 呼び出し hooks、状態管理、UI レンダリング。

## 前提条件

- 環境: Node 20 / Next.js 13 / SWR などのフェッチレイヤー。
- API: Issue #3 の投稿 API が稼働していること。
- テストユーザー: ログイン状態でページにアクセスできるよう Issue #4 の認証フローが完了していること。

## AC トレーサビリティ

| AC 番号 | 内容（要約）                                                                                | 検証ケース ID                            |
| ------- | ------------------------------------------------------------------------------------------- | ---------------------------------------- |
| AC-1    | `/timeline` が API のレスポンスをレンダリングし、ローディング・空状態を表示                 | TEST-05-01, TEST-05-02                   |
| AC-2    | タブ切替で `tab=following` を付けたリクエストを送る                                         | TEST-05-03                               |
| AC-3    | 投稿カードが likes_count・タグ等 API 値で表示される                                         | TEST-05-04                               |
| AC-4    | `/posts/:id` が API 呼び出し、404 時に専用メッセージ                                         | TEST-05-05, TEST-05-06                   |
| AC-5    | タイムライン・詳細ページとも API エラー時に適切なエラーメッセージを表示し、UX を阻害しない | TEST-05-07, TEST-05-08                     |

## テスト観点一覧

- ポジティブ: 正常データの表示、詳細ページ表示。
- ネガティブ: API エラー、404、空データ。
- UX: ローディングスピナー/状態文言。
- データ整合: likes_count / タグ/ユーザー情報が UI に反映。
- ルーティング: タブクエリ付与、リンク遷移。

## テストケース（詳細）

| ID         | 観点             | 目的                                                                    | 前提                                  | 手順                                                                                                                                                       | 期待結果                                                                                         | AC   |
| ---------- | ---------------- | ----------------------------------------------------------------------- | ------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------- | ---- |
| TEST-05-01 | タイムライン表示 | API モックのレスポンスを UI がレンダリングするか確認                    | MSW 等で `/api/v1/posts` をモック      | 1) `/timeline` を表示 2) ローディング中表示→API 応答→投稿カードが描画される流れを確認                                                                     | ローディング表示後、カードに書籍タイトル・likes_count・タグが表示                                | AC-1 |
| TEST-05-02 | 空状態           | API が空配列の場合の UI を確認                                          | 応答を空配列モック                    | 1) `/timeline` を表示 2) 空状態メッセージが表示されるか確認                                                                                                 | 「投稿がありません」等の空表示が出る                                                             | AC-1 |
| TEST-05-03 | タブ切替         | フォロー中タブ選択時に `tab=following` クエリ付きで API を呼ぶか確認    | MSW でリクエスト URL を検証           | 1) フォロー中タブをクリック 2) ネットワークリクエストを確認                                                                                                | `/api/v1/posts?tab=following` が呼ばれ、応答に応じた UI が表示                                    | AC-2 |
| TEST-05-04 | PostCard 表示    | likes_count・タグなど API 値がカードに反映されるか確認                  | API 応答に具体値を含める              | 1) `/timeline` を表示 2) カードから likes_count・タグ等の表示を検証                                                                                        | 表示が API 値と一致                                                                               | AC-3 |
| TEST-05-05 | 投稿詳細表示     | `/posts/:id` が API を呼び出し詳細を描画するか確認                      | MSW で `/api/v1/posts/:id` をモック   | 1) 任意 ID のページへアクセス 2) ローディング→詳細表示の流れを確認                                                                                        | 書籍情報・本文・タグ・likes_count が表示                                                         | AC-4 |
| TEST-05-06 | 投稿詳細 404     | API 404 時に専用メッセージが表示されるか確認                           | 404 応答をモック                      | 1) `/posts/:id` へアクセス 2) API から 404 応答 3) UI のエラーメッセージ・戻り導線を確認                                                                  | 「投稿が見つかりません」などの案内表示、必要ならタイムラインへのリンク                           | AC-4 |
| TEST-05-07 | タイムラインエラー | `/timeline` の API が 500 系エラー時に UI がエラー表示へ遷移するか確認 | MSW で `/api/v1/posts` に 500 を返却    | 1) `/timeline` を表示 2) API から 500 応答 3) エラーステートのメッセージやリトライ導線の有無を確認                                                     | API エラーメッセージ（例:「サーバーエラー」）または既定文言「タイムラインの取得に失敗しました」が表示される | AC-5 |
| TEST-05-08 | 投稿詳細エラー   | `/posts/:id` の API が 500 系エラー時に UI がエラー表示へ遷移するか確認 | MSW で `/api/v1/posts/:id` に 500 を返却 | 1) 任意 ID のページへアクセス 2) API から 500 応答 3) エラーバナーや戻るリンクが表示されるか確認                                                       | API エラーメッセージ（例:「投稿取得でエラーが発生しました」）または既定文言「投稿の取得に失敗しました」が表示 | AC-5 |

## データセット（例）

- MSW/Mock Service Worker で API レスポンスを制御。
- likes_count=10、tags=["文学","SF"] 等のサンプル。
- 404 モックでは `status: "error"` `error.code: "NOT_FOUND"` を返す。

## 実行コマンド例

```bash
npm run test            # React Testing Library
npm run test:e2e        # Playwright がある場合
npm run lint
```

## 成果物

- テスト結果を「検証結果」に記録し、必要に応じてスクリーンショットや録画を添付。

## 検証結果（記録用）

| 実施日     | 担当 | 結果 | メモ |
| ---------- | ---- | ---- | ---- |
| 2025/10/27 | codex | ✅ | `npm run test -- --run` 実行。Radix UI 経由の act 警告あり（前回と同内容、動作影響なし）。 |
| 2025/10/27 | codex support | ✅ | Vitest + MSW で TEST-05-01〜08 を自動実行。Radix UI 起因の act 警告あり（挙動への影響なし）。 |

## 要確認事項（未確定・オープン）

- フォロー中タブが Issue #12 完了まで空のままか、メッセージ表示仕様。
- API エラー時のリトライボタン有無（UX 設計次第）。

---
