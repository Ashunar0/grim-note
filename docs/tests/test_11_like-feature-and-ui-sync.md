**ファイルパス**: `docs/tests/test_11_like-feature-and-ui-sync.md`

# テストケース: いいね機能の実装と UI 同期

対象 Issue: #11  
関連ドキュメント:

- [要件定義書](../01_requirements.md)
- [API 設計](../04_api.md)

---

## 概要

- 目的: いいね API とフロント UI が同期し、カウント更新・権限制御・未認証処理が想定通り動作するか確認する。
- スコープ: `POST/DELETE /api/v1/posts/:id/like`、`likes_count` `is_liked` のレスポンス拡張、タイムライン/投稿詳細 UI のトグル操作。
- 対象: LikesController（仮）、Post モデル関連、Next.js の PostCard/詳細ページ。

## 前提条件

- 環境: Ruby 3.1.6 / Rails 7.2 / Node 20 / Next.js 13。
- 認証: ログインセッションが利用可能。
- データ: 投稿・ユーザー・likes フィクスチャを準備。

## AC トレーサビリティ

| AC 番号 | 内容（要約）                                                              | 検証ケース ID                    |
| ------- | ------------------------------------------------------------------------- | -------------------------------- |
| AC-1    | `POST/DELETE /posts/:id/like` が likes テーブルを更新し、重複登録を防ぐ   | TEST-11-01, TEST-11-02           |
| AC-2    | タイムライン・詳細 API に `likes_count` `is_liked` が含まれる            | TEST-11-03                       |
| AC-3    | フロントのいいねボタンが API 呼び出し後にカウント/表示を更新            | TEST-11-04                       |
| AC-4    | 未ログイン操作時にログインへの誘導が行われる                              | TEST-11-05                       |

## テスト観点一覧

- ポジティブ: いいね追加/取消し成功。
- ネガティブ: 重複 like、未認証アクセス。
- UI: 楽観的更新 or 再フェッチ、ハートアイコン状態。
- API: `is_liked` フラグ計算、likes_count 正確性。

## テストケース（詳細）

| ID         | 観点               | 目的                                                                   | 前提                                     | 手順                                                                                                                                      | 期待結果                                                                                         | AC   |
| ---------- | ------------------ | ---------------------------------------------------------------------- | ---------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------- | ---- |
| TEST-11-01 | API いいね追加     | `POST /posts/:id/like` で likes レコードが作成されるか確認             | ログイン済み、対象投稿が存在             | 1) `POST /api/v1/posts/:id/like` 実行 2) レスポンスと DB を確認                                                                           | 201 / `likes_count` 増加、`is_liked=true`                                                         | AC-1 |
| TEST-11-02 | API 取消し/重複防止 | `DELETE` による取消し、および重複 like の無視を確認                   | 同上                                    | 1) 既存 like 状態で再度 `POST` 実行（200/状態維持） 2) `DELETE` 実行→likes_count 減少                                                   | `POST` は 200 で状態変化なし、`DELETE` でカウントが元に戻る                                      | AC-1 |
| TEST-11-03 | API レスポンス     | タイムライン/詳細 API に `likes_count` と `is_liked` が含まれるか確認   | いいね済み/未いいね状態を作成            | 1) `GET /api/v1/posts` と `/posts/:id` を実行                                                                                             | 各投稿データに `likes_count` `is_liked` フィールドが存在                                         | AC-2 |
| TEST-11-04 | UI トグル           | フロントでボタン操作→カウント/ハート表示が更新されるか確認            | Next.js アプリが API に接続              | 1) `/timeline` でいいねボタンをクリック 2) カウント・ハート fill 状態が切り替わるか確認                                                  | ボタン押下で即座に状態反映。リロード後も反映                                                   | AC-3 |
| TEST-11-05 | 未認証処理         | 未ログインでいいね操作するとログイン誘導されるか確認                   | ログアウト状態                           | 1) `/timeline` でいいねボタンを押す 2) ダイアログ or `/login` リダイレクトを確認                                                         | ログイン導線が表示され、いいねは実行されない                                                    | AC-4 |

## データセット（例）

- likes フィクスチャ: ユーザーと投稿の組み合わせを 1 件以上。
- API スタブ（フロントテスト）: `is_liked` true/false 両方のレスポンス。
- Playwright で Cookie セッション操作。

## 実行コマンド例

```bash
bin/rails test TEST=test/requests/api/v1/post_likes_test.rb
npm run test          # UI トグルの単体テスト
npm run test:e2e      # Playwright でクリック操作確認
```

## 成果物

- テスト結果を「検証結果」に記録し、ログやスクリーンショットを必要に応じて添付。

## 検証結果（記録用）

| 実施日     | 担当 | 結果 | メモ |
| ---------- | ---- | ---- | ---- |
| 2025/10/28 | codex | ✅ | `bundle _2.3.27_ exec rails test`, `npm run test -- --run` |

## 要確認事項（未確定・オープン）

- 楽観的更新 vs 再フェッチどちらを採用するか。
- 連打時のレート制限、サーバー側での idempotency 処理。

---
