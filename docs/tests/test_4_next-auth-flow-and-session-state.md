**ファイルパス**: `docs/tests/test_4_next-auth-flow-and-session-state.md`

# テストケース: Next.js 認証フローとセッション状態

対象 Issue: #4  
関連ドキュメント:

- [要件定義書](../01_requirements.md)
- [API 設計](../04_api.md)
- [サイトマップ](../05_sitemap.md)

---

## 概要

- 目的: フロントエンドの登録/ログイン UI が API と連携し、セッション状態・ルーティング制御が仕様通りになることを検証する。
- スコープ: `/register` `/login` `/timeline` など認証導線、`/api/v1/me` を利用した共通 Auth コンテキスト、ヘッダー表示・リダイレクト制御。
- 対象: 認証フォーム、カスタム hook/context、API クライアント、保護ルートのガード。

## 前提条件

- 環境: Node 20 / Next.js 13 App Router / npm。
- API: Issue #2 で実装した認証 API が稼働していること（ローカル Rails サーバー）。
- テストユーザー: `alice@example.com / password123` など。

## AC トレーサビリティ

| AC 番号 | 内容（要約）                                                                     | 検証ケース ID                |
| ------- | -------------------------------------------------------------------------------- | ---------------------------- |
| AC-1    | ログイン/登録フォーム成功時にタイムライン遷移、エラー表示                         | TEST-04-01, TEST-04-02       |
| AC-2    | API クライアントが `credentials: "include"` を利用                                | TEST-04-03                   |
| AC-3    | `/api/v1/me` を用いた認証コンテキストがヘッダーへユーザー情報を反映              | TEST-04-04                   |
| AC-4    | 認証必須ページで未ログイン時に `/login` へリダイレクト                            | TEST-04-05                   |

## テスト観点一覧

- ポジティブ: 正常入力→遷移、セッション持続。
- ネガティブ: バリデーションエラー表示、ログイン失敗時の保持。
- UX: ローディング/エラーメッセージ表示。
- セッション: Cookie を含む fetch 設定、リロード後もユーザー状態復元。
- ルーティング: ガードが働き、未認証で保護ページへアクセスできない。

## テストケース（詳細）

| ID         | 観点                     | 目的                                                                 | 前提                                   | 手順                                                                                                                                               | 期待結果                                                                                                 | AC   |
| ---------- | ------------------------ | -------------------------------------------------------------------- | -------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- | ---- |
| TEST-04-01 | 登録フォーム成功         | 新規登録フォーム送信で API 成功→`/timeline` 遷移することを確認       | Rails API が稼働、未使用メールを用意   | 1) `/register` を開く 2) 必須項目を入力し送信 3) ネットワークログとページ遷移を確認                                                                | 201 応答、`/timeline` へ遷移、ヘッダーにユーザー名が表示                                                | AC-1 |
| TEST-04-02 | フォームエラー表示       | 誤った資格情報でエラーが表示されることを確認                         | 既存ユーザーのメールを利用             | 1) `/login` で誤パスワードを入力 2) 送信後のエラーメッセージと再入力可否を確認                                                                    | 401 応答を受けてフォーム内にエラーバナー表示、ページ遷移しない                                          | AC-1 |
| TEST-04-03 | API クライアント設定     | Fetch API が `credentials: "include"` をセットしていることを確認     | 認証用ユーティリティ実装済み           | 1) API クライアントまたは hook の単体テスト/スナップショットを確認 2) ネットワークパネルで Cookie 送信を確認                                     | リクエストヘッダーに Cookie が含まれ、コード上でも `credentials: "include"` が設定                      | AC-2 |
| TEST-04-04 | Auth コンテキスト        | `/api/v1/me` を利用したユーザー情報がコンテキスト経由で取得される    | ログイン成功後                          | 1) ページをリロード 2) `useAuth` などの hook のテスト or Playwright でヘッダー名が保持されることを確認                                           | リロード後もユーザー名/ログアウトメニューが表示                                                         | AC-3 |
| TEST-04-05 | 保護ルートリダイレクト   | `/timeline` 等に未ログインでアクセスした際にログインページへ戻す確認 | ログアウト状態                          | 1) ログアウト or Cookie 削除 2) `/timeline` へ直接アクセス                                                                                          | `/login` へリダイレクトされ、意図しない画面が表示されない                                               | AC-4 |

## データセット（例）

- 新規登録用メール: `test+<timestamp>@example.com`。
- Playwright/RTL 用モック: `msw` で `/api/v1/me` 応答をモックするなど。
- 認証状態変化の確認にはブラウザ Cookie をリセットする。

## 実行コマンド例

```bash
npm run lint
npm run test        # React Testing Library 等
# Playwright を導入した場合
npm run test:e2e
```

## 成果物

- テスト結果を「検証結果」に追記し、必要であればスクリーンショットを `docs/tests/assets/` へ保存。

## 検証結果（記録用）

| 実施日     | 担当      | 結果 | メモ |
| ---------- | --------- | ---- | ---- |
| 2025/10/26 | a.kawanobe | ✅   | フォーム送信・エラー表示・ログアウト・ページリロードを `npm run dev` 上で手動確認 |

## 要確認事項（未確定・オープン）

- Playwright/E2E を導入するか、React Testing Library のみで担保するか要決定。
- セッションタイムアウト時の UX（自動再ログイン vs. 強制ログイン画面遷移）。

---
