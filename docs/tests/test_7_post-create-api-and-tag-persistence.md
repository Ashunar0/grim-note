**ファイルパス**: `docs/tests/test_7_post-create-api-and-tag-persistence.md`

# テストケース: 投稿作成 API とタグ永続化

対象 Issue: #7  
関連ドキュメント:

- [要件定義書](../01_requirements.md)
- [DB スキーマ定義](../03_database.md)
- [API 設計](../04_api.md)

---

## 概要

- 目的: 投稿作成 API が本文・評価・読了日・タグ・書籍情報を保存し、バリデーションやタグ再利用が正しく動くことを検証する。
- スコープ: `POST /api/v1/posts`、タグ正規化サービス、書籍登録ロジック、エラーレスポンス。
- 対象: PostsController#create、Post モデルのトランザクション処理、Tag/PostTag 連携。

## 前提条件

- 環境: Ruby 3.1.6 / Rails 7.2。
- 認証: Issue #2 のセッション認証が有効（要ログインで access）。
- テストデータ: ユーザー、既存タグ、既存書籍をフィクスチャで準備。

## AC トレーサビリティ

| AC 番号 | 内容（要約）                                                                                              | 検証ケース ID                |
| ------- | --------------------------------------------------------------------------------------------------------- | ---------------------------- |
| AC-1    | 投稿作成時に posts/tags/post_tags をトランザクションで保存                                                | TEST-07-01                   |
| AC-2    | 既存タグの再利用・トリム/小文字化などの正規化                                                              | TEST-07-02                   |
| AC-3    | 書籍未登録時に books テーブルへ追加（手入力時は最小フィールドで作成）                                     | TEST-07-03                   |
| AC-4    | バリデーションエラー時に `VALIDATION_ERROR` を返しリクエストテストを追加                                  | TEST-07-04, TEST-07-05       |

## テスト観点一覧

- ポジティブ: 正常投稿、既存タグ使用、新規書籍作成。
- ネガティブ: 本文欠落、評価範囲外などのエラー。
- 境界値: 本文 500 文字、タグ数上限（仕様があれば）、評価 1/5。
- 整合性: トランザクションで失敗時ロールバック、タグ重複登録なし。

## テストケース（詳細）

| ID         | 観点                 | 目的                                                                          | 前提                                 | 手順                                                                                                                                          | 期待結果                                                                                                      | AC   |
| ---------- | -------------------- | ----------------------------------------------------------------------------- | ------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- | ---- |
| TEST-07-01 | 正常作成             | 投稿とタグがトランザクションで保存されることを確認                            | ログインユーザー、既存タグ1件         | 1) `POST /api/v1/posts` に本文・評価・読了日・タグ配列を送信 2) DB レコード(Post/Tag/PostTag) とレスポンスを確認                               | 201 / Post・Tag・PostTag が作成、レスポンスにもタグ配列が含まれる                                            | AC-1 |
| TEST-07-02 | タグ正規化           | 大文字・空白入りタグが正しく正規化・再利用されるか確認                        | `tags(:literature)` などが存在        | 1) `POST /api/v1/posts` で `" Literature "` 等を送信 2) 登録後のタグ ID と name を確認                                                        | 既存タグ ID が再利用され、新規タグが重複していない                                                           | AC-2 |
| TEST-07-03 | 書籍保存             | 未登録書籍が最小フィールドで books に追加されるか確認                          | 同一タイトルが未登録                  | 1) 書籍情報（タイトル/著者/ISBN なし）を含む投稿を送信 2) books テーブルに新規レコードが追加されているか確認                                 | 書籍が作成され、post がその book_id を参照                                                                    | AC-3 |
| TEST-07-04 | バリデーション       | 本文欠落・評価範囲外で `VALIDATION_ERROR` が返るか確認                         | -                                    | 1) 本文空でリクエスト 2) rating=6 でリクエスト                                                                                               | 422 / `error.code=VALIDATION_ERROR`、エラーメッセージが適切                                                  | AC-4 |
| TEST-07-05 | リクエストテスト     | 追加したリクエストテストが成功することを確認                                   | テスト環境構築済み                    | 1) `bin/rails test TEST=test/requests/api/v1/posts_create_test.rb` を実行                                                                    | 全テスト Pass                                                                                                | AC-4 |

## データセット（例）

- ユーザーフィクスチャ: `users(:alice)`。
- タグ: `tags(:literature)`。
- 書籍: `books(:norwegian_wood)`、手入力用はレスポンスモック。
- 境界文字列: `"a" * 500`、読み日: `Date.today`.

## 実行コマンド例

```bash
bin/rails test TEST=test/requests/api/v1/posts_create_test.rb
bin/rails test test/models/post_test.rb
```

## 成果物

- 検証結果を記録し、失敗時のリクエストログを添付。

## 検証結果（記録用）

| 実施日     | 担当 | 結果 | メモ |
| ---------- | ---- | ---- | ---- |
| 2025/10/27 | codex | ✅ | `bundle exec rails test TEST=test/requests/api/v1/posts_create_test.rb` 実行。タグ正規化・未登録書籍保存・バリデーションエラーを確認。 |

## 要確認事項（未確定・オープン）

- タグの最大数や長さ制限の仕様（未定の場合はテストで仮定を明示）。
- 書籍情報の必須フィールド（タイトル以外が省略可能か）。

---
