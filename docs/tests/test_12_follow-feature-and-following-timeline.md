**ファイルパス**: `docs/tests/test_12_follow-feature-and-following-timeline.md`

# テストケース: フォロー機能とフォロー中タイムライン

対象 Issue: #12  
関連ドキュメント:

- [要件定義書](../01_requirements.md)
- [API 設計](../04_api.md)
- [サイトマップ](../05_sitemap.md)

---

## 概要

- 目的: フォロー API・フォロー中タイムライン・UI ボタンが正しく連動し、状態が同期されるか確認する。
- スコープ: `POST/DELETE /api/v1/users/:id/follow`、`GET /api/v1/posts?tab=following`、プロフィール画面のフォローボタン＆タイムラインタブ。
- 対象: Follow モデル、UsersController、PostsController、Next.js UI。

## 前提条件

- 環境: Ruby 3.1.6 / Rails 7.2 / Node 20 / Next.js 13。
- 認証: Issue #2 のセッション認証。
- データ: ユーザー・投稿・フォロー関係のフィクスチャ。

## AC トレーサビリティ

| AC 番号 | 内容（要約）                                                                     | 検証ケース ID                    |
| ------- | -------------------------------------------------------------------------------- | -------------------------------- |
| AC-1    | `POST/DELETE /users/:id/follow` が follows を更新し、本人や重複フォローを拒否    | TEST-12-01, TEST-12-02, TEST-12-03 |
| AC-2    | `/users/:id` が最新のフォロー状態/フォロワー数を返す                             | TEST-12-04                       |
| AC-3    | `/posts?tab=following` がフォロー中ユーザーの投稿のみ返す                        | TEST-12-05                       |
| AC-4    | プロフィール画面とタイムラインでフォローボタン/タブの状態が同期                  | TEST-12-06                       |

## テスト観点一覧

- ポジティブ: フォロー追加→解除→再取得。
- ネガティブ: 自己フォロー、重複フォロー、未ログインアクセス。
- データ整合: フォロー中タイムラインの絞り込み。
- UI: フォローボタンの状態、タブの空表示。

## テストケース（詳細）

| ID         | 観点                 | 目的                                                                                | 前提                                   | 手順                                                                                                                                       | 期待結果                                                                                         | AC   |
| ---------- | -------------------- | ----------------------------------------------------------------------------------- | -------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- | ---- |
| TEST-12-01 | フォロー追加         | `POST /users/:id/follow` でフォローが成立するか確認                                 | 別ユーザーが存在                       | 1) API を実行 2) レスポンスと DB を確認                                                                                                    | 201 / `is_following=true`、フォロワー数が増える                                                 | AC-1 |
| TEST-12-02 | フォロー解除         | `DELETE` でフォロー解除しカウントが減るか確認                                       | フォロー済み状態                       | 1) `DELETE /users/:id/follow` 実行                                                                                                         | 200 / `is_following=false`、follow レコードが削除                                               | AC-1 |
| TEST-12-03 | 自己/重複防止        | 自己フォロー/重複フォローが拒否されるか確認                                         | -                                      | 1) 自分自身をフォロー→422 (`INVALID_OPERATION`) 2) 同じ相手に重複 `POST`→200 で状態変化なし                                               | エラーレスポンス/重複時は200で状態維持                                                         | AC-1 |
| TEST-12-04 | プロフィール更新     | フォロー操作後に `/users/:id` のフォロー状態・カウントが更新されるか確認            | フォロー追加/解除の後                  | 1) フォロー後に `GET /users/:id` 実行 2) `is_following`・`follower_count` などが最新値になっているか確認                                   | カウントが増減、`is_following` が true/false に反映                                             | AC-2 |
| TEST-12-05 | フォロータイムライン | `/posts?tab=following` がフォロー中ユーザー投稿のみ返すか確認                        | 複数ユーザー・投稿を用意               | 1) A が B をフォロー 2) `GET /posts?tab=following` を実行                                                                                   | レスポンスが B の投稿のみを含み、他ユーザーは含まれない                                         | AC-3 |
| TEST-12-06 | UI 同期              | フォローボタン/フォロー中タブが API 状態と同期するか確認                             | Next.js アプリが API と接続            | 1) プロフィールでフォローボタンを押す→表示切替確認 2) `/timeline` のフォロー中タブでカードが更新されるか確認                               | ボタン label・カウントが即座に更新、フォロー中タブで最新データが表示                           | AC-4 |

## データセット（例）

- `users(:alice)` `users(:bob)` `users(:carol)`。
- 投稿データ: フォロー対象ユーザーのみが持つ投稿。
- WebMock/Playwright で API レスポンスをモック。

## 実行コマンド例

```bash
bin/rails test TEST=test/requests/api/v1/user_follows_test.rb
npm run test          # UI の単体テスト
npm run test:e2e      # フォローボタン操作の E2E
```

## 成果物

- テスト結果を「検証結果」に記録、フォロー状態のスクリーンショットなどを必要に応じ添付。

## 検証結果（記録用）

| 実施日     | 担当 | 結果 | メモ |
| ---------- | ---- | ---- | ---- |
| 2025/10/28 | a.kawanobe | ✅ | `bundle _2.3.27_ exec rails test TEST=test/requests/api/v1/user_follows_test.rb` / `npm run test -- --run` / `npm run test:e2e` → **未定義コマンド** |

## 要確認事項（未確定・オープン）

- フォロー中タイムラインが空のときの文言・リトライ案内。
- 大量フォロー時のパフォーマンス（ページネーション仕様）。

---
