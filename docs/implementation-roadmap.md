# 実装ロードマップ

### フェーズ構成
- フェーズ1: ウォーキングスケルトン / #1, #2, #3, #4, #5
- フェーズ2: 体験拡充 / #6, #7, #8, #9, #10
- フェーズ3: 交流と運用強化 / #11, #12, #13, #14

### 依存関係マップ
#1 -> #2 -> #4 -> #5
#1 -> #3 -> #5 -> #11
#2 -> #6 -> #7 -> #8
#3 -> #9 -> #10 -> #12
#4 -> #13
#5, #8, #10, #12, #13 -> #14

#### Issue アウトライン表

##### Issue #1: データベーススキーマとモデル定義
**概要**: docs/03_database.md に沿って主要テーブルと ActiveRecord モデルの基盤を整備する。  
**依存**: -  
**ラベル**: backend  
**受け入れ基準（AC）**:
- [ ] users・books・posts・tags・post_tags・likes・follows テーブルを定義し、必須制約とインデックスを付与する
- [ ] 各モデルに関連付けと基本バリデーション（例: Post 本文 500 文字制限）を実装する
- [ ] `bin/rails db:migrate` と `bin/rails db:test:prepare` が通る
- [ ] 更新された `schema.rb` とモデルがレビュー可能な状態で提示される

##### Issue #2: セッション認証と現在ユーザー API
**概要**: メール認証とセッション Cookie 管理を実装し、現在ユーザー情報を取得できるようにする。  
**依存**: #1  
**ラベル**: backend, auth  
**受け入れ基準（AC）**:
- [ ] POST `/api/v1/users` が登録と同時にログインセッションを開始し、重複メール時は `VALIDATION_ERROR` を返す
- [ ] POST `/api/v1/login` がパスワードを検証し、失敗時に `UNAUTHORIZED` を返却する
- [ ] DELETE `/api/v1/logout` でセッション Cookie が削除される
- [ ] GET `/api/v1/me` が現在ユーザー情報を返し、未ログイン時は `UNAUTHORIZED` を返す
- [ ] 登録・ログイン・ログアウト・me のリクエストテストが追加される

##### Issue #3: 投稿タイムライン閲覧 API
**概要**: 新着タイムラインと投稿詳細を取得するエンドポイントを実装し、UI が必要とする情報を返す。  
**依存**: #1  
**ラベル**: backend  
**受け入れ基準（AC）**:
- [ ] GET `/api/v1/posts` が投稿を最新順で返し、ユーザー・書籍・タグ・likes_count を含む
- [ ] クエリ `page` でページネーションでき、無効値は 1 ページ目にフォールバックする
- [ ] GET `/api/v1/posts/:id` が詳細情報を返し、存在しない場合は `NOT_FOUND`
- [ ] タイムライン関連のリクエストテストが追加される

##### Issue #4: Next.js 認証状態管理とフォーム送信
**概要**: フロントのログイン・登録 UI を API 連携し、セッション状態とルート制御を整備する。  
**依存**: #2  
**ラベル**: frontend, auth  
**受け入れ基準（AC）**:
- [ ] ログイン/登録フォームが API を呼び出して成功時にタイムラインへ遷移し、エラー内容をフォーム内に表示する
- [ ] フロント共通の API クライアントで `credentials: "include"` を利用する
- [ ] `/api/v1/me` を利用した認証コンテキストまたは hook が追加され、ユーザー情報をヘッダーに反映する
- [ ] 認証必須ページで未ログイン時に `/login` へリダイレクトする

##### Issue #5: タイムラインと投稿詳細の API 連携
**概要**: タイムライン一覧と投稿詳細ページを API データ駆動に切り替え、ローディング/エラー処理を整える。  
**依存**: #3, #4  
**ラベル**: frontend  
**受け入れ基準（AC）**:
- [ ] `/timeline` が GET `/api/v1/posts` のレスポンスをレンダリングし、ロード中と空状態を表示できる
- [ ] タブ切り替え時に `tab=following` を付けたリクエストを送る実装が入り、フォロー中タブは Issue #12 まで空表示で劣化しない
- [ ] 投稿カードが likes_count やタグなど API 値を使用する
- [ ] `/posts/:id` が GET `/api/v1/posts/:id` を呼び出し、404 時に専用メッセージを表示する

##### Issue #6: Google Books 検索サービス実装
**概要**: Google Books API 呼び出しをラップするサービスと `/api/v1/books/search` を実装する。  
**依存**: #2  
**ラベル**: backend, external  
**受け入れ基準（AC）**:
- [ ] サービスクラスで Google Books API を呼び出し、タイトル・著者・出版年・ISBN13 を正規化する
- [ ] GET `/api/v1/books/search` が `q` パラメータ必須で結果を返し、0 件時は空配列を返却する
- [ ] 失敗時に `SERVER_ERROR` を返し、ログへスタックトレースを残す
- [ ] API キーを `ENV["GOOGLE_BOOKS_API_KEY"]` から取得し、設定手順をドキュメント化する

##### Issue #7: 投稿作成 API とタグ永続化
**概要**: 投稿作成エンドポイントを完成させ、タグ正規化と書籍情報保存ロジックを整える。  
**依存**: #1, #2, #6  
**ラベル**: backend  
**受け入れ基準（AC）**:
- [ ] POST `/api/v1/posts` が本文・評価・読了日・タグを受け取り、トランザクションで posts/tags/post_tags を作成する
- [ ] 既存タグは再利用され、大小文字や前後空白を除去した上で保存される
- [ ] 書籍が未登録の場合に books テーブルへ追加し、手入力時は必要なフィールドのみで作成できる
- [ ] バリデーションエラーが `VALIDATION_ERROR` で返却され、リクエストテストが追加される

##### Issue #8: 投稿作成 UI の API 連携
**概要**: 書籍検索と投稿作成ページをバックエンドと接続し、エラーハンドリングを実装する。  
**依存**: #4, #6, #7  
**ラベル**: frontend  
**受け入れ基準（AC）**:
- [ ] `/books/search` が API 結果を表示し、ロード中・エラー・0 件表示を切り替える
- [ ] 検索結果から選んだ書籍情報が `/posts/new` のフォームに反映される
- [ ] 投稿フォーム送信時に POST `/api/v1/posts` が呼ばれ、成功時にタイムラインへリダイレクトする
- [ ] バリデーションエラー時にフォーム内へメッセージが表示され、送信ボタンの多重押下が防止される

##### Issue #9: プロフィール閲覧・編集 API
**概要**: プロフィール表示と自己更新の API を実装し、フォロー情報の下準備を整える。  
**依存**: #1, #2, #3  
**ラベル**: backend  
**受け入れ基準（AC）**:
- [ ] GET `/api/v1/users/:id` がプロフィール情報と投稿一覧、follower_count・following_count・post_count を返す
- [ ] レスポンスに `is_following` と `is_self` を含める（未ログイン時は false）
- [ ] PATCH `/api/v1/profile` が名前・自己紹介・アイコン URL を更新し、本人以外は `FORBIDDEN`
- [ ] プロフィール取得・更新のリクエストテストが用意される

##### Issue #10: プロフィール UI の API 連動
**概要**: プロフィール表示・編集 UI を API と接続し、フォロー導線の表示制御を行う。  
**依存**: #4, #9  
**ラベル**: frontend  
**受け入れ基準（AC）**:
- [ ] `/users/:id` が API レスポンスを描画し、投稿が無い場合の空状態も表示できる
- [ ] `ProfileHeader` が `is_self` で編集ボタンの表示・非表示を切り替える
- [ ] `/users/:id/edit` が初期値を API から読み込み、PATCH `/api/v1/profile` 成功後にプロフィールへ戻る
- [ ] 本人以外が編集 URL にアクセスした際にトップまたはログインへリダイレクトする

##### Issue #11: いいね機能の実装と UI 同期
**概要**: いいね付与・解除 API を実装し、タイムラインと詳細画面のリアクションを同期させる。  
**依存**: #5  
**ラベル**: backend, frontend  
**受け入れ基準（AC）**:
- [ ] POST/DELETE `/api/v1/posts/:id/like` が likes テーブルを更新し、重複登録を防止する
- [ ] タイムライン・詳細 API に `likes_count` と `is_liked` が含まれる
- [ ] フロントのいいねボタンが API を呼び出し、成功時にカウントとハート表示が反映される
- [ ] 未ログイン時の操作でログインダイアログまたはリダイレクトが表示される

##### Issue #12: フォロー機能とフォロー中タイムライン
**概要**: フォロー管理とフォロー中タブのデータ取得を整備し、プロフィールから操作できるようにする。  
**依存**: #5, #9, #10, #11  
**ラベル**: backend, frontend  
**受け入れ基準（AC）**:
- [ ] POST/DELETE `/api/v1/users/:id/follow` が follows テーブルを更新し、本人や重複フォローを拒否する
- [ ] GET `/api/v1/users/:id` がフォロー状態とフォロワー数を最新値で返す
- [ ] GET `/api/v1/posts?tab=following` がフォロー中ユーザーの投稿のみ返す
- [ ] プロフィール画面とタイムラインでフォローボタン/フォロー中タブがリアルタイムに状態更新される

##### Issue #13: 通報フォームとお問い合わせ送信
**概要**: 通報 API を実装し、問い合わせページから Slack/Google Form へ転送できるようにする。  
**依存**: #4  
**ラベル**: backend, frontend, external  
**受け入れ基準（AC）**:
- [ ] POST `/api/v1/reports` が post_id・category・message を受け取り、Slack Webhook もしくは Google Form に連携する
- [ ] 送信成功時に成功レスポンスを返し、失敗時は `SERVER_ERROR` とユーザー向けエラーメッセージを表示する
- [ ] `/contact` ページが API を呼び出し、送信中インジケータと完了メッセージを表示する
- [ ] `/posts/:id` の通報ボタンから `?postId=` クエリで遷移した場合にフォームが自動入力される

##### Issue #14: 品質ゲートと自動化整備
**概要**: Lint/テストを自動化し、MVP の品質と運用手順を明文化する。  
**依存**: #5, #8, #10, #12, #13  
**ラベル**: infra, backend, frontend  
**受け入れ基準（AC）**:
- [ ] GitHub Actions で `bin/rails test`, `bin/rubocop`, `npm run lint` を実行するワークフローが追加される
- [ ] ローカル実行用に lint/test をまとめたスクリプトまたは make タスクが追加される
- [ ] 主要 API とフロントのユースケースに対するテスト（Minitest リクエストテスト + smoke レベルの React テスト）が追加される
- [ ] `AGENTS.md` もしくは README に品質チェックの手順が追記される

### 要確認事項
- 通報連携は Slack Webhook・Google Form のどちらを優先採用するか（運用負荷によって分岐実装が変わる）
- タイムライン API を未ログイン利用者に公開するか認証必須にするか（UI はログイン前提だが仕様が混在しているため確認したい）
- Google Books API キーの管理方法（Vercel/Render での環境変数命名やレート制限対策）の合意が必要
